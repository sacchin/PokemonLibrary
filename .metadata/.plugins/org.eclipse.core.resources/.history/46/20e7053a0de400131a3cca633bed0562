package com.gmail.sacchin.pockemonbattletools.http;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.io.PrintStream;
import java.net.MalformedURLException;
import java.net.URL;
import java.net.URLConnection;
import java.security.spec.KeySpec;
import java.util.ArrayList;
import java.util.List;

import org.apache.http.HttpResponse;
import org.apache.http.HttpStatus;
import org.apache.http.NameValuePair;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.http.message.BasicNameValuePair;
import org.apache.http.util.EntityUtils;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import net.vvakame.util.jsonpullparser.JsonFormatException;

import android.util.Log;

public class PGLGetter implements Runnable {

	private final static String URL = "http://3ds.pokemon-gl.com/frontendApi/gbu/getSeasonPokemonDetail";

	public String doPost(int pockemonNo) {
		StringBuilder result = new StringBuilder();

		DefaultHttpClient client = new DefaultHttpClient();
		HttpPost method = new HttpPost(URL);
		method.setHeader("Referer", "http://3ds.pokemon-gl.com/battle/");

		// リクエストパラメータの設定
		List<NameValuePair> params = new ArrayList<NameValuePair>();	    
		params.add(new BasicNameValuePair("languageId", "1"));
		params.add(new BasicNameValuePair("seasonId", "3"));
		params.add(new BasicNameValuePair("battleType", "0"));
		params.add(new BasicNameValuePair("timezone", "JST"));
		params.add(new BasicNameValuePair("pokemonId", pockemonNo + "-0"));
		params.add(new BasicNameValuePair("displayNumberWaza", "10"));
		params.add(new BasicNameValuePair("displayNumberTokusei", "3"));
		params.add(new BasicNameValuePair("displayNumberSeikaku", "10"));
		params.add(new BasicNameValuePair("displayNumberItem", "10"));
		params.add(new BasicNameValuePair("displayNumberLevel", "10"));
		params.add(new BasicNameValuePair("displayNumberPokemonIn", "10"));
		try {
			method.setEntity(new UrlEncodedFormEntity(params, "utf-8"));
			HttpResponse response = client.execute(method);

			switch (response.getStatusLine().getStatusCode()) {
			case HttpStatus.SC_OK:
				Log.d("PGLGetter", "レスポンス取得に成功");
				//				BufferedReader reader = new BufferedReader(new InputStreamReader(response.getEntity().getContent(), "UTF-8"));
				//				while(true){
				//					String temp = reader.readLine();
				//					if(temp == null){
				//						break;
				//					}
				//					Log.e("result", "" + result.length());
				//					result.append(temp);
				//				}
				result.append(EntityUtils.toString(response.getEntity(), "UTF-8"));
				break;
			case HttpStatus.SC_NOT_FOUND:
				Log.e("PGLGetter", "データが存在しない");
				break;
			default:
				Log.e("PGLGetter", "通信エラー");
				break;
			}

		} catch (ClientProtocolException e) {
			return "Error:" + e.getStackTrace();
		} catch (IOException e) {
			return "Error:" + e.getStackTrace();
		} catch (Exception e) {
			return "Error:" + e.getStackTrace();
		}
		return result.toString();
	}

	@Override
	public void run() {
		try {
			String jsonStr = doPost(303);
			if(jsonStr != null && !jsonStr.isEmpty()){
				JSONObject j = new JSONObject(jsonStr);
				Iterable<String> keys = (Iterable<String>) j.keys();
				for(String k : keys){
					Log.e("PGLGetter", k);
				}
			
				
				String statusCode = j.getString("status_code");
				JSONArray rankingPokemonSuffererWaza = j.getJSONArray("rankingPokemonSuffererWaza");
				JSONArray rankingPokemonSufferer = j.getJSONArray("rankingPokemonSufferer");
				JSONArray rankingPokemonIn = j.getJSONArray("rankingPokemonIn");
				JSONObject rankingPokemonTrend = j.getJSONObject("rankingPokemonTrend");
//				JSONArray rankingPokemonSuffererWaza = j.getJSONArray("rankingPokemonSuffererWaza");
//				JSONArray rankingPokemonSuffererWaza = j.getJSONArray("rankingPokemonSuffererWaza");
//				JSONArray rankingPokemonSuffererWaza = j.getJSONArray("rankingPokemonSuffererWaza");
//				JSONArray rankingPokemonSuffererWaza = j.getJSONArray("rankingPokemonSuffererWaza");
//				
//				
//			{"status_code":"0000",
//				"rankingPokemonSuffererWaza":[
//				                              {"ranking":1,"typeId":9,"usageRate":50.0,"wazaName":"ヘドロばくだん","sequenceNumber":1},
//	            "rankingPokemonSufferer":[
//	                                          {"monsno":479,"formNo":"1","ranking":1,"pokemonId":"479-1","countBattleByForm":1,"battlingChangeFlg":0,"typeId1":5,"typeId2":3,"typeName2":"ほのお","formName":null,"typeName1":"でんき","name":"ロトム","sequenceNumber":1},
//                "rankingPokemonIn":[
//                                              {"monsno":6,"formNo":"0","ranking":1,"pokemonId":"6-0","countBattleByForm":1,"battlingChangeFlg":1,"typeId1":3,"typeId2":6,"typeName2":"ひこう","formName":null,"typeName1":"ほのお","name":"リザードン","sequenceNumber":1},
//			    "beforePokemonId":"718-0",
//			"rankingPokemonTrend":{"wazaInfo":[{"ranking":1,"typeId":9,"usageRate":63.333333333333336,"name":"ヘドロばくだん","sequenceNumber":1},
//			{"ranking":2,"typeId":7,"usageRate":36.666666666666664,"name":"ねむりごな","sequenceNumber":2},
//			{"ranking":3,"typeId":7,"usageRate":36.666666666666664,"name":"やどりぎのタネ","sequenceNumber":3},
//			{"ranking":4,"typeId":1,"usageRate":26.666666666666668,"name":"まもる","sequenceNumber":4},
//			{"ranking":5,"typeId":7,"usageRate":26.666666666666668,"name":"はなびらのまい","sequenceNumber":5},
//			{"ranking":6,"typeId":7,"usageRate":23.333333333333332,"name":"ハードプラント","sequenceNumber":6},
//			{"ranking":7,"typeId":1,"usageRate":23.333333333333332,"name":"ウェザーボール","sequenceNumber":7},
//			{"ranking":8,"typeId":9,"usageRate":23.333333333333332,"name":"どくどく","sequenceNumber":8},
//			{"ranking":9,"typeId":7,"usageRate":16.666666666666668,"name":"リーフストーム","sequenceNumber":9},
//			{"ranking":10,"typeId":7,"usageRate":13.333333333333334,"name":"くさのちかい","sequenceNumber":10},
//			{"ranking":0,"typeId":0,"usageRate":109.99999999999997,"name":null,"sequenceNumber":0}],
//			"seikakuInfo":[{"ranking":1,"usageRate":66.66666666666667,"name":"ひかえめ","sequenceNumber":1},
//			{"ranking":2,"usageRate":10.0,"name":"てれや","sequenceNumber":2},
//			{"ranking":3,"usageRate":3.3333333333333335,"name":"しんちょう","sequenceNumber":3},
//			{"ranking":4,"usageRate":3.3333333333333335,"name":"なまいき","sequenceNumber":4},
//			{"ranking":5,"usageRate":3.3333333333333335,"name":"おだやか","sequenceNumber":5},
//			{"ranking":6,"usageRate":3.3333333333333335,"name":"おっとり","sequenceNumber":6},
//			{"ranking":7,"usageRate":3.3333333333333335,"name":"ようき","sequenceNumber":7},
//			{"ranking":8,"usageRate":3.3333333333333335,"name":"おくびょう","sequenceNumber":8},
//			{"ranking":9,"usageRate":3.3333333333333335,"name":"やんちゃ","sequenceNumber":9}],
//			"tokuseiInfo":[{"ranking":1,"usageRate":93.33333333333333,"name":"しんりょく","sequenceNumber":1},
//			{"ranking":2,"usageRate":6.666666666666667,"name":"ようりょくそ","sequenceNumber":2}],
//			"itemInfo":[{"ranking":1,"usageRate":26.666666666666668,"name":"しんかのきせき","sequenceNumber":1},
//			{"ranking":2,"usageRate":26.666666666666668,"name":"きあいのタスキ","sequenceNumber":2},
//			{"ranking":3,"usageRate":13.333333333333334,"name":"こだわりメガネ","sequenceNumber":3},
//			{"ranking":4,"usageRate":10.0,"name":"フシギバナイト","sequenceNumber":4},
//			{"ranking":5,"usageRate":3.3333333333333335,"name":"おおきなねっこ","sequenceNumber":5},
//			{"ranking":6,"usageRate":3.3333333333333335,"name":"かわらずのいし","sequenceNumber":6}]},
//			"rankingPokemonInfo":{"monsno":1,"formNo":"0","ranking":486,"pokemonId":"1-0","weight":"69.0","typeId1":7,"typeId2":9,"typeName2":"どく","formName":null,"typeName1":"くさ","name":"フシギダネ","sequenceNumber":486,"height":"70.0"},
//			"rankingPokemonDown":[{"monsno":115,"formNo":"1","ranking":1,"pokemonId":"115-1","countBattleByForm":1,"battlingChangeFlg":1,"typeId1":1,"typeId2":0,"typeName2":null,"formName":null,"typeName1":"ノーマル","name":"ガルーラ","sequenceNumber":1},
//			{"monsno":663,"formNo":"0","ranking":2,"pokemonId":"663-0","countBattleByForm":0,"battlingChangeFlg":0,"typeId1":3,"typeId2":6,"typeName2":"ひこう","formName":null,"typeName1":"ほのお","name":"ファイアロー","sequenceNumber":2},
//			{"monsno":94,"formNo":"1","ranking":3,"pokemonId":"94-1","countBattleByForm":1,"battlingChangeFlg":1,"typeId1":16,"typeId2":9,"typeName2":"どく","formName":null,"typeName1":"ゴースト","name":"ゲンガー","sequenceNumber":3},
//			{"monsno":711,"formNo":"3","ranking":4,"pokemonId":"711-3","countBattleByForm":1,"battlingChangeFlg":0,"typeId1":16,"typeId2":7,"typeName2":"くさ","formName":null,"typeName1":"ゴースト","name":"パンプジン","sequenceNumber":4},
//			{"monsno":700,"formNo":"0","ranking":5,"pokemonId":"700-0","countBattleByForm":0,"battlingChangeFlg":0,"typeId1":18,"typeId2":0,"typeName2":null,"formName":null,"typeName1":"フェアリー","name":"ニンフィア","sequenceNumber":5},
//			{"monsno":681,"formNo":"1","ranking":6,"pokemonId":"681-1","countBattleByForm":1,"battlingChangeFlg":1,"typeId1":17,"typeId2":16,"typeName2":"ゴースト","formName":null,"typeName1":"はがね","name":"ギルガルド","sequenceNumber":6},
//			{"monsno":658,"formNo":"0","ranking":7,"pokemonId":"658-0","countBattleByForm":0,"battlingChangeFlg":0,"typeId1":12,"typeId2":11,"typeName2":"あく","formName":null,"typeName1":"みず","name":"ゲッコウガ","sequenceNumber":7},
//			{"monsno":645,"formNo":"1","ranking":8,"pokemonId":"645-1","countBattleByForm":1,"battlingChangeFlg":0,"typeId1":8,"typeId2":6,"typeName2":"ひこう","formName":null,"typeName1":"じめん","name":"ランドロス","sequenceNumber":8},
//			{"monsno":472,"formNo":"0","ranking":9,"pokemonId":"472-0","countBattleByForm":0,"battlingChangeFlg":0,"typeId1":8,"typeId2":6,"typeName2":"ひこう","formName":null,"typeName1":"じめん","name":"グライオン","sequenceNumber":9},
//			{"monsno":468,"formNo":"0","ranking":10,"pokemonId":"468-0","countBattleByForm":0,"battlingChangeFlg":0,"typeId1":18,"typeId2":6,"typeName2":"ひこう","formName":null,"typeName1":"フェアリー","name":"トゲキッス","sequenceNumber":10}],
//
//			"rankingPokemonDownWazaOther":{"ranking":0,"typeId":0,"usageRate":5.0,"wazaName":"その他","sequenceNumber":0},
//			"nextPokemonId":"2-0",
//			"rankingPokemonDownWaza":[{"ranking":1,"typeId":11,"usageRate":10.0,"wazaName":"ふいうち","sequenceNumber":1},
//			{"ranking":2,"typeId":9,"usageRate":10.0,"wazaName":"ヘドロばくだん","sequenceNumber":2},
//			{"ranking":3,"typeId":15,"usageRate":10.0,"wazaName":"いわなだれ","sequenceNumber":3},
//			{"ranking":4,"typeId":8,"usageRate":10.0,"wazaName":"じしん","sequenceNumber":4},
//			{"ranking":5,"typeId":11,"usageRate":5.0,"wazaName":"イカサマ","sequenceNumber":5},
//			{"ranking":6,"typeId":13,"usageRate":5.0,"wazaName":"サイコショック","sequenceNumber":6},
//			{"ranking":7,"typeId":17,"usageRate":5.0,"wazaName":"アイアンヘッド","sequenceNumber":7},
//			{"ranking":8,"typeId":9,"usageRate":5.0,"wazaName":"クロスポイズン","sequenceNumber":8},
//			{"ranking":9,"typeId":6,"usageRate":5.0,"wazaName":"ブレイブバード","sequenceNumber":9},
//			{"ranking":10,"typeId":6,"usageRate":5.0,"wazaName":"エアスラッシュ","sequenceNumber":10},
//			{"ranking":0,"typeId":0,"usageRate":25.0,"wazaName":null,"sequenceNumber":0}],
//				"timezoneName":"JST"}

			
			
			
			
				
				
			}
		} catch (JSONException e) {
			e.printStackTrace();
		}
	}

	public static URLConnection createURLConnection(URL url) throws IOException {
		URLConnection uc = url.openConnection();
		uc.setDoOutput(true);//POST可能にする
		uc.setRequestProperty("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8");
		uc.setRequestProperty("Referer", "http://3ds.pokemon-gl.com/battle/");
		return uc;
	}

	public static String get(int pockemonNo) throws IOException {
		String s = "";
		try {
			URL url = new URL(URL);
			URLConnection uc = createURLConnection(url);
			OutputStream os = uc.getOutputStream();//POST用のOutputStreamを取得

			// ヘッダを設定
			String postStr = "languageId=1&" + 
					"seasonId=3&" + 
					"battleType=0&" + 
					"timezone=JST&" + 
					"pokemonId=" + pockemonNo + "-0&" + 
					"displayNumberWaza=10&" + 
					"displayNumberTokusei=3&" + 
					"displayNumberSeikaku=10&" + 
					"displayNumberItem=10&";
			PrintStream ps = new PrintStream(os);
			ps.print(postStr);//データをPOSTする
			ps.close();

			InputStream is = uc.getInputStream();//POSTした結果を取得
//			BufferedReader reader = new BufferedReader(new InputStreamReader(is, "UTF-8"));
//			while ((s = reader.readLine()) != null) {
//				Log.e("while", s);
//			}
			InputStreamReader reader = new InputStreamReader(is, "UTF-8");
			int i = 0, count = 0;
			while ((i = reader.read()) != -1) {
				count++;
			}
			reader.close();
			Log.e("while", "" + count);
			return s;
		} catch (MalformedURLException e) {
			Log.e("result", "Invalid URL format: " + URL);
		} catch (IOException e) {
			Log.e("result", "Can't connect to " + URL);
		}

		return s;
	}
}
